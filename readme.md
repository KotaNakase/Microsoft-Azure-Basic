# Azure基礎(IaaS)
### **取り扱い事項**
* 仮想マシン
* 仮想ネットワーク
* ネットワークセキュリティグループ
* ストレージアカウント
* ロードバランサ
* 仮想マシンスケールセット
* Azure Buckup
* Azure Monitor
* Log Analytics

### セクション2
#### クラウドとは
コンピュータ資源をサービスとして提供する利用形態のこと  
* 必要に応じてユーザー自身がWeb画面からシステムの調達や各種設定を行えるこ（オンデマンドセルフサービス）  
※一番イメージしやすいサービスはSaaSのDropBox
* 様々なデバイスからネットワーク経由で利用できること（幅広いネットワークアクセス）  
※EC2で作成した仮想マシンはどこからでもアクセスできる(鍵は必要)
* CPUやディスクなどのリソースがプールされていて需要に応じて利用できること（リソースの共有）  
※
* 必要に応じてシステムの拡大や縮小を即座に行えること（スピーディーな拡張性）  
※EC2での設定でメモリサイズを指定したりすること
* どれくらい使ったか計測できる仕組みを持ち、使った分だけ支払うことができること（サービスが計測可能）  
※AWSでもトップ画面に表示されている

#### サービスモデル
* IaaS  
サーバ、ストレージ、ネットワーク等インフラ設備を提供するサービス。(AWSでのEC2)
* PaaS  
アプリケーションを動かすためのOS、ミドルウェアまで提供するサービス(AWSでのS3,Lambda)
* SaaS  
上記の設備に加えてアプリケーションまで提供するサービス(Gmail,DropBox)

#### ジオとリージョン
* ジオ(国)
* リージョン(西日本、東日本)  
リージョン内に複数データセンターがある(可用性を高めるために分散されて配置されている)

#### **Azureの基礎**

#### Azure費用計算ツール
以下のリンクを参照(料金明細等作成可能)  
https://azure.microsoft.com/ja-jp/pricing/calculator/


#### 予算アラートの設定
請求額が設定した金額を超えた際にメールを受信することができる  
サブスクリプション>Azure subscription 1>予算 から設定可能

#### リソースグループの作成
* 開発環境用途に合わせてグルーピングしてリソースの管理を容易に行える
* 課金明細をグループ毎に出力できる
* グループ単位で権限を付与できる  
リソースグループ>+作成 から作成可能

---
### セクション3
#### **仮想マシンの作成**
**Virtual Machines**>作成>Azure 仮想マシン を選択
1. 基本  
プロジェクトの詳細からリソースグループ  
インスタンスの詳細から仮想マシン名、地域、イメージを選択  
イメージは **[smalldisk] Windows Server 2022 Datacenter -x64 Gen2** を選択(OSの選択)  
* smalldisk→30GB 標準→127GB
* VMアーキテクチャ→CPUのこと
* 仮想マシンのメモリサイズは**B2ms**を使用
* 管理者アカウントの設定

2. ディスク  
Premium SSDを使用(デフォルト)

3. ネットワーク  
仮想ネットワーク、サブネット、パブリックIPはデフォルトのまま(自動生成)  
パブリック受信ポートをRDP(3389)でのみ受け付けるよう設定  
※NIC(ネットワークインターフェースカード)を削除するかのチェック項目について  
そもそも仮想なのでNICを模した動きをするソフトウェアを残して消すか、まとめて削除するかの違い。ElasticSearchでルールがあるけど見に行く先のIndexがない状態のようなもの。残したところで特に意味はない(多分)。

4. 管理  
基本はデフォルト設定のまま。自動シャットダウンを設定したい場合はチェックマークから設定を行う。(消し忘れによるコスト増加を抑える)

5. Monitoring  
ブート診断の設定  
ブート診断とは...仮想マシン起動時のスクリーンショットを保存してくれる機能。サーバーに接続できない場合に仮想マシンが起動しているかどうかの確認ができる。デフォルトでAzureが用意したストレージに保存してくれる(らしい)

6. 詳細  
拡張機能の設定が可能

#### 仮想マシンの取り扱い(セットアップ)
* 仮想マシン作成後の確認  
※仮想ネットワーク作成時、リソースグループにNetworkWatcherRGというグループが自動生成される。

* ネットワークウォッチャーとは  
Azure内のネットワーク系の監視ツールの総称をそのように呼ぶ。
詳細な情報は  
https://qiita.com/mynkw1090/items/228ed93b2b4c94c83659

* 仮想マシンの停止と開始  
  * Virtual Machines>からVMを選択し、停止を選択。  
  **※必ずAzure Portalからシャットダウンすること。リモートデスクトップからOSの操作でシャットダウンしても課金し続けるので注意!**  
  割り当て解除となっていることを確認すること。
  * **OSディスクのストレージ費用は常に課金されるため、今後使用しない仮想マシン・それに関連するリソースは削除すること。**  

* 仮想マシンの日本語化  
  1. ホストPCから仮想マシン(パブリックIPアドレス)へリモートデスクトップ接続。
  2. Server ManagerからTime Zoneを日本時間に変更。
  3. Windowsの設定を開き、Add languageから日本語を追加
  4. Rigionから地域を変更
  5. 関連設定の言語設定から日本語を選択。
  6. 再起動後にリモートデスクトップ接続して日本語化されていることを確認。

* 仮想マシン上のCドライブ・Dドライブについて  
ホストサーバーのアップデート・障害などで、仮想マシンが別のホストマシンに移動するとき、Dドライブ上のデータは消失してしまう。
→Dドライブの領域はホストマシンの領域(物理サーバのディスク)であるため**Dドライブは一時領域として使用することが推奨されている。**

  Cドライブについてはネットワーク上のストレージに接続しているため、ホストマシンが移動してもデータが保存される。

#### Sysprepの設定
sysprepとは...PCを複製する前に共通する設定情報を消去する為に使うツール
対象PCの特有の情報を削除する。(SID、イベントログ、ネットワーク設定、OSのライセンス)  
→固有の情報を省いた状態でPCのクローンを作成する。

Sysprepの実行はPowerShellから  
C:\Windows\System32\sysprep\sysprep.exe /generalize /oobe /mode:vm /shutdown を入力

#### イメージからVMの作成
VMの作成と同様の手順で作成できる。
すでに作成した仮想ネットワーク、サブネットを選択して作成。パブリックIPはイメージの作成と同時に削除したため、新たに作成。  
※イメージから作成したVMは日本語化されていなかった。日本語化パッケージはインストールされていたが、表示言語は英語のままだった。OSの設定によっては反映されないものもあるため、検証が必要とのこと。(タイムゾーンの設定も同様)

---
### セクション4
行うこと
* VM2台作成(環境含む)
* 作成したVMにIISをインストールし、htmlファイルを配置
* ブート診断のデータをBlobストレージに保存するような構成

#### 仮想ネットワークの作成
Vnet内のトラフィックを制御するためのネットワークセキュリティグループ(nsg)はサブネットに割り当てる場合が多いので許可・拒否するパターンに応じたセキュリティ観点での分割がおすすめ。

→VirtualNetwork内のデータ量を制御するnsgセキュリティ観点毎にサブネットに設定し観点毎にグループ分けするとよい。

仮想ネットワーク>作成  
* IPアドレスタブ内の設定を行い、作成。サブネットの設定もここで行う。
* 仮想ネットワーク作成後に、サブネットの追加も行える。

#### NSG(ネットワークセキュリティグループ)の作成
ネットワークセキュリティグループ>作成
リソースグループ、名前を設定して作成。設定はデプロイ後に行う。

nsgを開くと受信セキュリティと送信セキュリティのルールが表示されている。
それぞれの意味は、
* 65000(AllowVnetInBound)...同じ仮想ネットワーク内の受信を許可

* 65000(AllowVnetOutBound)...同じ仮想ネットワーク内の送信を許可

* 65001(AllowAzureLoadBalancerInBound)...ロードバランサから任意の宛先への通信が許可されている。  
ロードバランサを使う場合に通信を分散する宛先のサーバを死活監視するために必要。  
→ロードバランサが宛先サーバの負荷を常に確認できるように許可している。そんなイメージ

* 65001(AllowInternetOutBound)...任意の場所からのインターネット宛の通信が許可されている。  
→インターネットに出ていく通信のこと。これのおかげで言語パックがインストール出来た。

* 65500(DenyAllInBound)...受信を全て拒否する。

* 65500(DenyAllOutBound)...送信を全て拒否する。

※ルールを追加するときの優先度は100~4096の間で指定できる。
また、NSGでは数字の若い順に評価されていく。

1. ポート番号、ソース、優先度など指定して作成。  
NSG>w-iaas-nsg>設定>受信セキュリティ規則>追加 から行う。

2. 作成したNSGをサブネットに適用する。  
NSG>w-iaas-nsg>設定>サブネット>関連付け から行う。  
※この設定はネットワークインターフェースにも適用できる。

使い分け方  
→仮想ネットワーク内で共通のルールはサブネットに関連付けを行い、サーバ毎の個別のルールはネットワークインターフェースに関連付けするとよい。

※VM作成時に自動生成されたNSGの関連付け先はネットワークインターフェースである。

#### 可用性セットの作成
可用性セット>作成 から行う。
* 障害ドメイン...電源やネットワーク機器を共有する範囲  
サーバーラックのようなもの。ラックに障害があった場合は同じラックにホストされている仮想マシンが影響を受ける。

* 更新ドメイン...アップデートを同時に適用する範囲
アップデート・再起動を一斉に行うことを防ぐ目的のもの。範囲を広げて分散させて実行できる。

* 可用性セット...上記二つの設定を行うことで、セットとして扱える。  
→**一つのデータセンターの中でサーバーを分散させる仕組み。**  
※可用性セットなしで作成した仮想マシンを後から可用性セットに配置することはできない。**可用性セットの作成→仮想マシンの作成の順で行うこと。**

* 可用性ゾーン...データセンター規模の障害に備えるための仕組み  
→**データセンターがある地域が停電・災害など発生しても別の地域のデータセンターを使用してサービスを継続できるようにする仕組み。**

#### ストレージアカウントの作成
ストレージアカウント>作成 から行う。

* ストレージアカウント名は全世界でユニークである必要がある。(被りなし)
* 冗長性はLRSを選択。(GRSは別のリージョンにもデータを複製するもの)
* その他の設定については本講座ではデフォルトで進めている。以下に代表的な設定項目を記載。
  * Blobストレージのアクセス層
    * HOT(アクセス頻度の高いデータ)
    * COOL(アクセス頻度の低いデータ・バックアップ)
  * ネットワーク接続
    * ストレージへのアクセス権の設定
  * データ保護
    * 削除したデータを期間内であれば復元可能

#### Webサーバ用の仮想マシンの作成
これまで作成したリソースを選択して仮想マシンを作成していく。  
**地域がランダムで設定されてしまい、可用性セット選択がうまくいかないことがある。原因は不明。**
* ネットワークセキュリティグループについては既にサブネットに関連付けがなされているため、ここでは「なし」を選択。
* ブート診断の項目については、本講座であらかじめ作成したストレージアカウントを使用するため、「Enable with Custom storage account」を選択。

#### 仮想マシンのスケールアップ
VM>設定>サイズ から行う。  
※仮想マシンのサイズ変更時は再起動が行われるのであらかじめVMを停止しておく。

#### IISのインストール
IIS...Microsoftが作った無料のWebサーバソフトのこと  
仮想マシン内にPower Shellを用いてIISをインストールする  
コマンドは以下の通り
* IISインストール  
Install-WindowsFeature web-server

* ブート診断  
VMを選択し、ヘルプからブート診断を選択。  
VMが立ち上がっているか。どの常態か確認できるツール。

---
### セクション5
#### ロードバランサの構成
* パブリックロードバランサの作成  
→インターネットからの通信を振り分ける

ロードバランサの負荷分散方式  
以下の5つの値を組み合わせて求められるハッシュ値から振り分け先を決定する。
* 送信元IPアドレス
* 送信元ポート番号
* 送信先IPアドレス
* 送信先ポート番号
* プロトコル

**ロードバランサの構成手順**
1. ロードバランサの作成  
同時にパブリックIPアドレスも作成する
2. バックエンドプールの追加  
負荷分散する対象のVMを登録する
3. 正常性プローブの作成  
バックエンドプールのVMを死活監視し、異常があれば切り離す。
4. 負荷分散規則の追加  
待ち受けポートと転送先ポートのマッピングや、2,3との関連付けを行う
5. インバウンドNAT規則の追加  
ロードバランサを経由したRDP接続のための設定(ポートフォワーディング)

#### ロードバランサの作成
ロードバランサ>追加 から行う。
* SKUはStandardを推奨している。
* 種類はパブリックロードバランサを作成するので、**パブリック**に変更する。
* フロントエンドIP構成の追加を行う。  
※その他の設定(バックエンドプール、正常性プローブ、負荷分散規則)はここでは行わない。

#### バックエンドプールの作成
ロードバランサ>バックエンドプール>追加 から行う。  
追加したいVMを選択して保存。  
※IPを直接指定することも可能。

#### 正常性プローブの作成
ロードバランサ>正常性プローブ>追加 から行う。  
* プロトコルの選択  
TCPの場合はポートに接続できるかどうか。  
HTTP/HTTPSの場合はstatusCode200が返ってくるかどうか。
指定した条件で接続できない場合、ダウンしたと見なされ、VMが切り離される。

* パス(HTTP/HTTPSの場合)  
特定のパスにアクセスできるかどうかも設定可能。

* 間隔  
何秒間隔で確認するかの指定。

#### 負荷分散規則の作成
ロードバランサ>負荷分散規則>追加 から行う。
* フロントエンドIPアドレス、バックエンドプールは作成したものを選択。
* ポート、バックエンドポートは共に80を入力。  
※TCP/ポート(80)宛に通信が来た場合にバックエンドプール(VM01,VM02)のバックエンドポート(80)に転送される
* 正常性プローブは作成したものを選択。
* セッション永続化は、ロードバランサの振り分けで使用するハッシュ値を何の要素を使用して作成するか。
  * なしの場合  
  5個の要素でハッシュ値を作成する  
  * 有効にした場合(クライアントIP,クライアントIPとプロトコル)  
  →ポート番号をハッシュ値作成に使用しないので、クライアントIPやプロトコルが変わらなければ、常に同じサーバに接続される。  
  ⇒**セッションが維持される。**

#### 負荷分散の動作確認
IISを起動・停止したとき、ロードバランサがIISが起動していない転送先を切り離すか
* IIS停止コマンド  
Stop-service W3SVC

* IIS常態確認コマンド  
Get-service W3SVC

* IIS停止コマンド  
Start-service W3SVC

#### インバウンドNAT規則の追加
パブリックIPを入力することでロードバランサに紐付いたVMが自動で振り分けが行われるが、NAT規則の追加することで**パブリックIP:ポート番号**と入力することで自動振り分けされずに特定のVMに接続できる。

ロードバランサー>インバウンドNAT規則>追加 から行う。  
フロントエンドポートに任意のポート番号を入力する。(一般的に使用されていないポート番号を推奨)

---
### セクション6
#### Azure Storage
* 耐久性に優れ、容易に拡張でき、安全性の高いストレージサービス。
  * Blob  
  テキストデータやバイナリデータ等大量の非構造化データを格納できる。安価。  
  動画や音声ファイル、バックアップデータの保存に使用される。
  * File
  SMB/NFDプロトコルに対応したファイル共有サービス。Windows,Linux,macOSにマウント可能でオンプレミス環境のファイルサーバの代わりとして利用するのが一般的。(SVNのクラウド版のような？)
  * Table
  半構造化データを格納するNOSQLキーバリューストアサービス。  
  キーと値が一対一で紐付いて1行ずつ保存されており、大量のデータに高速でアクセスできる。
  * Queue
  コンポーネント間の非同期通信に使うメッセージングサービス。  
  仲介役としてQueueストレージを間にかませることで、サーバ同士、機能同士が依存しない疎結合になるようにするもの。  
  送信側のコンポーネント→Queue  
  Queue→受信側のコンポーネント  
  ⇒非同期通信のためのサービス。

* ストレージアカウントを作成して各種サービスを利用する。

* オブジェクトストレージとは  
オブジェクト単位でデータを管理するストレージ。オブジェクトIDと呼ばれる識別子で管理されている。  
階層構造をもたないので拡張性・可用性に優れている。

* Azure Storageの冗長オプション
  * ローカル冗長ストレージ(LRS)  
  選択したリージョン内のデータセンター3箇所にそれぞれデータの複製が行われる。
  * 地理冗長ストレージ(GRS)  
  選択したリージョンのペアリージョンのデータセンター3箇所にそれぞれデータの複製が行われる。  
  データへのアクセスはできない。
  * 読み取りアクセス地理冗長ストレージ(RA-GRS)  
  GRSとは違い、読み取りアクセスが可能なストレージ。

※フェールオーバーしたときのみ、セカンダリリージョン内のデータにアクセス可能。(手動でも可)

#### Storage内データの確認方法
ストレージアカウント>コンテナー フォルダのようなもの(コンテナー)が保存されている。その中に保存されるファイルをBlobという。  
ブート診断の結果はbmpファイルとlogファイルで持っている。

* コンテナーの作成  
パブリックアクセスレベル→どの範囲で公開するか。
  * プライベート...外部からのアクセス不可
  * BLOB...作成するコンテナー内のファイルに読み取りアクセス可。
  * コンテナー...コンテナー内のファイルの一覧をリストで確認可。

#### Azure Storage Explorerの使い方
Windows,Linux,macOSで使用できるサービス。Azureストレージを管理できる。直感的に操作できて便利。
1. Azure Storage Explorerをインストール。
2. Azureでサインインする。
3. 閲覧対象のサブスクリプションを選んで閲覧。
アップロード、ダウンロード、削除等ファイル操作を行うことができる。

#### Fileの使い方
サービスのうちのひとつの方のFile。ネットワークドライブとしてストレージを割り当てて、Azure Portal,Explorerでファイル、フォルダの操作が行える。  
ストレージアカウント>ファイル共有>ファイル共有 から行う。  
作成後、接続を選択すると、それぞれのOSにマウントするためのコマンドが表示される。  
PowerShellでコマンドを入力することでネットワークドライブが生成される。  

※マウント...OSに周辺機器の接続を認識させる命令のこと。Linuxではよくでる。Windowsはその必要に駆られることはほぼない。

* Explorer補足  
ストレージブラウザーというプレビュー機能にExplorerに近いサービスがある。今後正式にリリースされるかも。

#### Blobのアクセスレベルの変更
* プライベート  
外部からの閲覧不可

* BLOB  
BLOBの閲覧が可能。

* BLOBの閲覧に加えて、リストの表示も可能。  
リストの閲覧  
?restype=container&comp=list  
をURLに付与することで閲覧可能。

---
### セクション7
#### 仮想マシンスケールセットの作成
仮想マシンスケールセットとは  
スケジュールや負荷の状態によって、サーバの台数を自動的に増減する機能を持った仮想マシン群(VMSS)  
※無料版の場合CPUコア数が4個までなのでここでVM01を削除した。

* オーケストレーションモード
  * 均一  
  同じ構成の仮想マシンを複数台作る場合に選択。
  * フレキシブル  
  別構成のOS、環境、サイズの仮想マシンを複数台作成する場合に選択。

* OSのイメージ  
すべてのイメージ>マイイメージ から選択可能。

* ネットワークインターフェース  
ネットワークインターフェースの編集からサブネット、NIC、パブリック受信ポートなどの設定が可能。

* ロードバランサの作成
全てデフォルトで作成。

#### DSCを使用したIISの自動インストール
自動スケーリングで仮想マシンが増減するよう設定しても、その度にIISをインストールするのは非効率で非現実的。  
→DSCで自動化を図る

VMSS>拡張機能とアプリケーション>追加 から行う。
1. PowerShell Desired State Configurationを選択。
2. Scriptの項目にはZipファイルを選択。予め、コンテナー内にZipファイルを格納してそのパスを参照した。
3. Configurationに以下の内容を入力。  
WindowsWebServer.ps1\IISInstall
4. versionには2.83を入力。バージョンの履歴は以下を参照。  
https://learn.microsoft.com/ja-jp/azure/automation/automation-dsc-extension-history?view=powershell-7
5. 作成
6. VMSSからインスタンスの状態を確認。以下の通りになっている。

DSC作成前に作成したインスタンスに対してDSCの構成情報が反映されていない状態。  
→アップグレードを行う。

アップグレード後にパブリックIPでアクセスしたときに仮想マシンの名前が表示されていれば成功。

#### リソースプロバイダーの登録
リソースプロバイダーからmicrosoft.insightsを検索して登録。  
自動スケールの設定に必要なため。  
機能を無効状態から使える状態にしているイメージ?

#### 自動スケールの設定
VMSS>スケーリング>カスタム自動スケーリング> から行う。
* スケーリングの条件
  * メトリックに基づいてスケーリングする  
  CPU使用率に基づいてスケーリング  
  メトリック...ルーターが通信経路を決定する際に使用する値。実行可能なルートのうち最適なルートを決定するために使われる値。

  * 特定のインスタンス数にスケーリングする  
  日時、時間を指定して台数を増減することができる。  
  例)土日の18:00~24:00は増加　等々

* ルールの追加  
規則を追加する から行う。
  * 演算子、期間、平均、Actionを選択してスケールイン・スケールアウトの条件を作成する。  
  ※一つのスケーリングにスケールイン・スケールアウトはセットで作成すること。

* インスタンスの制限  
インスタンスの初期値、スケールインした際の最大値、スケールアウトした際の最小値を指定。

#### 自動スケール補足説明
* 用語解説
* 期間粒度...値を取得する間隔
* 期間...取得された値を集計する時間幅(ルールの実行周期のようなもの)
* 時間の集計...期間内の値を集計する方法(KQL、ルールの種類(CustomQuery,Threshold)のようなもの)
* 時間グレインの統計...期間粒度の値をどのように決定するか。   
例)期間粒度が1分の時、1分間の最大値をとるのか、平均値をとるのか、等々。

#### 自動スケールの動作確認
VMに負荷をかけることで自動スケールが発動することを確認する。  
VMSS>インスタンス から台数を確認できる。また、スケーリング>実行履歴 からスケールイン、スケールアウトの実行履歴を確認できる。

---
### セクション8
#### サポートプランの種類
ヘルプとサポートから現在のプランのサポート内容や、他サイトでのサポートが紹介されている。サポートリクエストの送信も可能。メールの履歴はリクエスト毎に確認できる。  
**疑問点の解消に役立つブログ記事**  
http://aka.ms/jpaztech

---
### セクション9
#### 仮想マシンのカスタマイズ
#### IPアドレスの固定
VM>ネットワーク>ネットワークインターフェース>IP構成>ipconfig1 から行う。  
動的から静的に変換し、仮想ネットワーク内の範囲でIPを指定。  
※第4オクテットが0,1,2,3のアドレスはAzureで既に割り当てられているので、4以降のものを指定する必要がある。  
変更後、VMを再起動して反映。

#### DNSの指定
DNSの指定は仮想ネットワークのメニューから行える。行わない場合は、AzureのDNSサーバを参照する。  
また、VM>ネットワーク>DNSサーバ からも指定が行える。  
NICに設定...NICが接続されている単一のVMに適用  
Vnetに設定...Vnetに所属している全てのVMに適用
両方に設定...NICに登録したDNSサーバが優先される

#### ネットワークインターフェースの接続と切断
ネットワークインターフェースは仮想マシン作成時に自動生成されるものであり、名前の変更など行う場合は別途ネットワークインターフェースを作成して付け替える必要がある。

* ネットワークインターフェースの付け替え手順
  1. ネットワークインターフェースを新規作成
  2. パブリックIPを付け替える(関連付けしていない場合は不要)
  3. 作成したネットワークインターフェースをVMに接続する
  4. 旧ネットワークインターフェースを切断する
  5. 旧ネットワークインターフェースを削除する

1. ネットワークインターフェースを新規作成  
ネットワークインターフェース>追加 から行う。
IPアドレスの割り当ては「静的」、アドレスは任意で作成。

2. パブリックIPを付け替える(関連付けしていない場合は不要)  
パブリックIPアドレス>関連付けの解除 から行う。  
解除後、新規作成したネットワークインターフェースとIPアドレスの関連付けを行う。  
リソースの種類とネットワークインターフェースを選択して関連付け。

3. 作成したネットワークインターフェースをVMに接続する  
VM>ネットワーク から行う。  
接続前にVMは停止しておく必要がある。

4. 旧ネットワークインターフェースを切断する
接続後、旧インターフェースをデタッチする。

5. 旧ネットワークインターフェースを削除する  
ネットワークインターフェース から旧インターフェースを削除する。

VMに接続できるネットワークインターフェースには上限があり、詳細は下記アドレスの汎用に記載されている。  
https://learn.microsoft.com/ja-jp/azure/virtual-machines/sizes-b-series-burstable

#### OSディスクの拡張
VM>ディスク>ディスク名>サイズ及びパフォーマンス から行う。

初期値の30GBはWindows ServerのSmallDiskを選択していたため。
また、現在の容量を下回る設定はできないため、慎重に行う必要がある。  
※仮想マシンが停止されていないとサイズ変更時エラーが発生する。

拡張後、仮想マシン上で設定を変更することで初めて拡張が適用される点に注意。
ディスクの管理 から未割り当て領域をCドライブに割り当てするだけで完了。

* ディスク関連の用語
  * IOPS(Input Output Per Secound)...1秒間あたりに処理できる読み書きの数。
  * スループット...1秒間あたりのデータ転送量(MB/秒)
  * マネージドディスク...Azureの仮想マシンのディスクのこと。実態はBlobストレージに管理されている。

### データディスクの追加
ディスク>追加 から行う。  
作成後、VM>ディスクから既存のディスクのアタッチを選択し、作成したディスクを追加する。VMからディスクの管理を開き、追加したデータディスクを適用させる。  
※ディスクのサイズは手入力で指定することも可能ではあるが、プロビジョニングされた容量より小さく指定しても値段は変わらないので、あえて小さいディスクサイズ指定する必要はない。

#### スナップショットの作成
スナップショットとは...ある時点でのディスクの状態をコピーしたもの。バックアップを取得するときに便利。(Virtual Boxにもあった)取得はディスク単位で行われる。 
費用は実際の使用量に応じて課金される。  

ディスク>スナップショットの作成> から作成
* フル、増分いずれかでスナップショットを作成できる。

#### スナップショットからの復元(1)
スナップショットから仮想マシンを復元する方法は以下の2通りある。  
* 仮想マシンを新規作成する  

  既存の仮想マシンはそのままで、新たに仮想マシンを作成する。残しておきたい場合に推奨。また、IPアドレスは別のものが割り当てられる。
  1. スナップショットからディスクを復元する。(OS,Dataそれぞれのディスクを作成)
  2. 復元したディスクから仮想マシンを作成する。

* 既存の仮想マシンのディスクを交換する  
既存のマシンのディスクのみを交換する  
仮想マシン名、IPアドレスはそのまま使用できる。

  1. スナップショットからディスクを復元する。(OS,Dataそれぞれのディスクを作成)
  2. OSディスクの「スワップ」という機能を使用してディスクを交換する。


1. スナップショットからディスクの復元  
  1-1. スナップショット>OSディスク>ディスクの作成 を選択。  
  1-2. ストレージを指定して作成。  
  1-3. 同様の操作でDataディスクも復元。  
2. 復元したディスクから仮想マシンを作成する。  
  2-1. ディスク>作成したOSディスクを選択。
  2-2. 仮想マシンを作成。  
  ※この後もOSディスクを使用するのでディスクのオプションの、VMとともに削除はしない。

復元した仮想マシンと既存の仮想マシンの名前は違うが、コンピュータ名は同じになっているので、同時に起動する際はどちらかをOSの画面から変更すること。

#### スナップショットからの復元(2)
1. スナップショットからディスクの復元  
上の工程で実施済。

2. OSディスクの「スワップ」という機能を使用してディスクを交換する。  
VM>ディスク>OSディスクのスワップを選択。  
変更したいディスクを選択して実行。

    データディスクについては、既存のディスクをデタッチして、変更したいディスクをアタッチすることで、交換可能。

イメージから仮想マシンを作成する場合  
→同じ環境のVM、構成を複数台作成する場合に使用

スナップショットから仮想マシンを作成する場合  
→バックアップの復元や検証の用途で使用

#### AzureポータルからPowerShellを実行
VM>実行コマンド から実行可能。  
複数コマンドが用意されており、選択するだけで実行可能。  
RunPowerShellScriptから自由にコマンド入力することも可能。
簡単な確認であればおすすめな機能。

---
### セクション10
#### Azure Backupとは
Azureまたはオンプレミスの仮想マシンをバックアップ/リストアできる。
* Azure Backupの仕組み
1. 仮想マシンに接続されている全てのディスクをバックアップする。
2. Recovery servicesコンテナー(バックアップを保存するためのストレージ)に転送する。
仮想マシンとリージョンは一致していないとバックアップができない。

#### Azure Backupの構成手順
1. Recovery Servicesコンテナーを作成する。
2. レプリケーションの変更。(学習目的のため、GRS→LRS)
3. バックアップポリシーを作成する。
4. バックアップ対象の仮想マシンを登録する。

* インスタントリストアとは  
バックアップを取得する時間をカットできる仕組み。従来の仕組みの場合、コンテナーにバックアップデータをアップした後にスナップショットは削除されていた。  
データを復元する際に、コンテナーから取得する時間や、コンテナーへのデータ送信中の時間がボトルネックになっていた。  
→インスタントリストアでは指定した日数分バックアップデータをローカル保持してくれる。

#### オンデマンドバックアップの実行
手動で行うバックアップのこと。
* ボリューム・シャドウコピー・サービス(VSS)  
仮想マシンを起動した状態でも整合性を保ったまま、バックアップできる機能。すでに備わっている。

バックアップアイテム>今すぐバックアップ から行う。  
※Azureのバックアップに関わる操作の処理結果はバックアップジョブで確認できる。

バックアップアイテム>復旧ポイント について
* 回復の種類
  * スナップショット  
  スナップショット取得完了、コンテナー転送未完了。ローカルストレージに保存。
  * スナップショットと資格情報コンテナー  
  スナップショット取得完了、コンテナー転送完了。ローカルストレージ、コンテナーに保存。
  * コンテナー  
  コンテナーに保存。インスタントリストアの保持日数経過後。

* バックアップの保持期限について
オンデマンドでバックアップの保持期限を指定した場合、作成後変更は不可であるが、ポリシーによって実行されたバックアップの期限変更は有効。期限を延長した場合、ほかの復元ポイントも全て延長される。逆に短くして期限切れになったバックアップはAzureのcleanup処理で削除される。

#### Backupからの復元
* 仮想マシンを新規作成する。
* 仮想マシンのディスクを交換する。
* 仮想マシンのディスクを復元する。(交換はしない)
* ファイルの回復

* 仮想マシンを新規作成する。  
  1. コンテナーから取得。
  2. スナップショットからディスクを復元。
  3. 仮想マシンを作成。
  4. データディスクを接続。  
  ※1.の手順はインスタントリストアのデータがあれば、行われない。

1. 仮想マシンを新規作成する。

復元の構成
* サイズ...元の仮想マシンを引き継ぐ。
* ユーザー名/パスワード...元の仮想マシンを引き継ぐ。
* パブリックIPアドレス...元の仮想マシンのNICに割り当てられている場合は新規作成。
* 可用性セット...元の仮想マシンから引き継がれない。(配置不可)

仮想マシンを新規作成する方法では、復元した仮想マシンをカスタマイズすることはできないので、要注意。(簡易的な復元)

2. 仮想マシンのディスクを交換する。  
1.と同様にバックアップアイテム>VMの復元 から今回は、既存を置換を選択。  
ストレージアカウントを選択して、実行。

3. バックアップからの復元  
コンテナー内のスナップショットデータを用いてディスクを復元するのみ行う。  
そのディスクから自由にカスタマイズできるため、便利。(新規作成、交換...)
OSディスクの不調・データディスクからのデータ取得など用途に合わせて扱うことができる。  
1.2.と同様にバックアップアイテム>VMの復元 から今回は、ディスクの復元を選択。  
ディスクの作成のみ行うため、仮想マシンを新規作成するより時間がかからない。

4. ファイルの回復  
今回は、バックアップアイテム>ファイルの回復 を選択。  
※復元するファイルのサイズは最大で10GBまで。転送量は1GB/時間となっているため、場合によっては3.の復元方法(ディスクの復元)を行うとよい。  
  4-1. Azureポータルからスクリプトをダウンロード  
  4-2. 仮想マシン上でスクリプトを実行(コンテナー上のディスクをマウントする)  
  ※iSCSI接続してネットワークごしにコンテナーに接続するための操作。(ローカルディスクとして認識されるようになる)  
  4-3. ファイルコピー後、ポータルでマウントの解除を行い、終了。

#### バックアップの停止と削除
* バックアップの停止  
バックアップアイテム>バックアップの停止 を選択でバックアップが停止する。  
実行後、ポリシーの関連付けが解除され、バックアップが行えなくなる。再開するには、バックアップの再開から行える。

* バックアップデータの削除  
バックアップデータの削除から実行できる。復元ポイント毎の削除はできず、すべてのデータが削除されるので注意。softDeleteを有効にしている場合、指定日数データを復旧できるのでテスト環境でなければ有効が推奨。
---
### セクション11
#### Azure Monitor
利用統計情報を管理・分析するためのサービス。オンプレミスや他社のクラウドのサーバの監視も可能。
複数のログ管理・監視サービスを統合したサービス。
* Log Analytics(logstash)
* アラート(Kibana)  
を用いて監視を行う。(CloudWatch,Kibanaあたりの機能に近い役割)  

構成手順
1. Log analyticsワークスペースを作成。(収集データの保管場所)
2. データ収集ルールの作成(logstashのような役割)  
本講座ではCPU使用率などのパフォーマンスカウンターのデータを収集できるよう設定。  
データ収集ルールを作成することで、仮想マシンの拡張機能としてエージェントが自動でインストールされる。これによって、ワークスペースにデータが送られるようになる。
3. アクショングループの作成  
アラートの送り先の指定。
4. アラートルールの設定  
DetectionRuleのようなもの。

#### 監視システムの構成
* Log analyticsワークスペースの作成
* データ収集ルールの作成  
Log analytics>エージェント管理 から行う。

#### Log analyticsの使い方
ルールの作成にはKQLが必要(**Kibanaではない**)  
Kusto Query Language=KQL  

#### アラートルールの登録
モニター>ログ>新しいアラートルール から作成。
* 測定
  * メジャー(レコード数を数えるか、指定した列の数値を見るか)
  * 集計の粒度(DetectionRuleのRuntimeのようなもの)
* アラートロジック  
閾値のこと

* レコード件数
* CPU使用率
* メモリ使用率 を監視してアラートするルールを作成する。

* **メール通知が確認できなかったので、後日確認**
* レコード件数、CPU使用率、メモリ使用率それぞれ確認できなかった。リソースは保存してある。

