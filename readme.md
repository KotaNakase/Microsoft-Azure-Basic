# Azure基礎(IaaS)
### **取り扱い事項**
* 仮想マシン
* 仮想ネットワーク
* ネットワークセキュリティグループ
* ストレージアカウント
* ロードバランサ
* 仮想マシンスケールセット
* Azure Buckup
* Azure Monitor
* Log Analytics

### セクション2
#### クラウドとは
コンピュータ資源をサービスとして提供する利用形態のこと  
* 必要に応じてユーザー自身がWeb画面からシステムの調達や各種設定を行えるこ（オンデマンドセルフサービス）  
※一番イメージしやすいサービスはSaaSのDropBox
* 様々なデバイスからネットワーク経由で利用できること（幅広いネットワークアクセス）  
※EC2で作成した仮想マシンはどこからでもアクセスできる(鍵は必要)
* CPUやディスクなどのリソースがプールされていて需要に応じて利用できること（リソースの共有）  
※
* 必要に応じてシステムの拡大や縮小を即座に行えること（スピーディーな拡張性）  
※EC2での設定でメモリサイズを指定したりすること
* どれくらい使ったか計測できる仕組みを持ち、使った分だけ支払うことができること（サービスが計測可能）  
※AWSでもトップ画面に表示されている

#### サービスモデル
* IaaS  
サーバ、ストレージ、ネットワーク等インフラ設備を提供するサービス。(AWSでのEC2)
* PaaS  
アプリケーションを動かすためのOS、ミドルウェアまで提供するサービス(AWSでのS3,Lambda)
* SaaS  
上記の設備に加えてアプリケーションまで提供するサービス(Gmail,DropBox)

#### ジオとリージョン
* ジオ(国)
* リージョン(西日本、東日本)  
リージョン内に複数データセンターがある(可用性を高めるために分散されて配置されている)

#### **Azureの基礎**

#### Azure費用計算ツール
以下のリンクを参照(料金明細等作成可能)  
https://azure.microsoft.com/ja-jp/pricing/calculator/


#### 予算アラートの設定
請求額が設定した金額を超えた際にメールを受信することができる  
サブスクリプション>Azure subscription 1>予算 から設定可能

#### リソースグループの作成
* 開発環境用途に合わせてグルーピングしてリソースの管理を容易に行える
* 課金明細をグループ毎に出力できる
* グループ単位で権限を付与できる  
リソースグループ>+作成 から作成可能

### セクション3
#### **仮想マシンの作成**
**Virtual Machines**>作成>Azure 仮想マシン を選択
1. 基本  
プロジェクトの詳細からリソースグループ  
インスタンスの詳細から仮想マシン名、地域、イメージを選択  
イメージは **[smalldisk] Windows Server 2022 Datacenter -x64 Gen2** を選択(OSの選択)  
* smalldisk→30GB 標準→127GB
* VMアーキテクチャ→CPUのこと
* 仮想マシンのメモリサイズは**B2ms**を使用
* 管理者アカウントの設定

2. ディスク  
Premium SSDを使用(デフォルト)

3. ネットワーク  
仮想ネットワーク、サブネット、パブリックIPはデフォルトのまま(自動生成)  
パブリック受信ポートをRDP(3389)でのみ受け付けるよう設定  
※NIC(ネットワークインターフェースカード)を削除するかのチェック項目について  
そもそも仮想なのでNICを模した動きをするソフトウェアを残して消すか、まとめて削除するかの違い。ElasticSearchでルールがあるけど見に行く先のIndexがない状態のようなもの。残したところで特に意味はない(多分)。

4. 管理  
基本はデフォルト設定のまま。自動シャットダウンを設定したい場合はチェックマークから設定を行う。(消し忘れによるコスト増加を抑える)

5. Monitoring  
ブート診断の設定  
ブート診断とは...仮想マシン起動時のスクリーンショットを保存してくれる機能。サーバーに接続できない場合に仮想マシンが起動しているかどうかの確認ができる。デフォルトでAzureが用意したストレージに保存してくれる(らしい)

6. 詳細  
拡張機能の設定が可能

#### 仮想マシンの取り扱い(セットアップ)
* 仮想マシン作成後の確認  
※仮想ネットワーク作成時、リソースグループにNetworkWatcherRGというグループが自動生成される。

* ネットワークウォッチャーとは  
Azure内のネットワーク系の監視ツールの総称をそのように呼ぶ。
詳細な情報は  
https://qiita.com/mynkw1090/items/228ed93b2b4c94c83659

* 仮想マシンの停止と開始  
  * Virtual Machines>からVMを選択し、停止を選択。  
  **※必ずAzure Portalからシャットダウンすること。リモートデスクトップからOSの操作でシャットダウンしても課金し続けるので注意!**  
  割り当て解除となっていることを確認すること。
  * **OSディスクのストレージ費用は常に課金されるため、今後使用しない仮想マシン・それに関連するリソースは削除すること。**  

* 仮想マシンの日本語化  
  1. ホストPCから仮想マシン(パブリックIPアドレス)へリモートデスクトップ接続。
  2. Server ManagerからTime Zoneを日本時間に変更。
  3. Windowsの設定を開き、Add languageから日本語を追加
  4. Rigionから地域を変更
  5. 関連設定の言語設定から日本語を選択。
  6. 再起動後にリモートデスクトップ接続して日本語化されていることを確認。

* 仮想マシン上のCドライブ・Dドライブについて  
ホストサーバーのアップデート・障害などで、仮想マシンが別のホストマシンに移動するとき、Dドライブ上のデータは消失してしまう。
→Dドライブの領域はホストマシンの領域(物理サーバのディスク)であるため**Dドライブは一時領域として使用することが推奨されている。**

  Cドライブについてはネットワーク上のストレージに接続しているため、ホストマシンが移動してもデータが保存される。

#### Sysprepの設定
sysprepとは...PCを複製する前に共通する設定情報を消去する為に使うツール
対象PCの特有の情報を削除する。(SID、イベントログ、ネットワーク設定、OSのライセンス)  
→固有の情報を省いた状態でPCのクローンを作成する。

Sysprepの実行はPowerShellから  
C:\Windows\System32\sysprep\sysprep.exe /generalize /oobe /mode:vm /shutdown を入力



